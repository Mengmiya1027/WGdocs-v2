name: æ„å»ºå¹¶ä¸Šä¼ VitePressæ–‡æ¡£

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ— éœ€æ¨é€ä»£ç 

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    name: æ„å»ºæ–‡æ¡£å¹¶ä¸Šä¼ åˆ°WebDAV
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿å®Œæ•´æ£€å‡ºä»£ç 

      - name: é…ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          echo "ğŸ”§ å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
          if npm ci; then
            echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
          else
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨npm installé‡è¯•..."
            npm install && echo "âš ï¸ ä½¿ç”¨npm installå®‰è£…æˆåŠŸ" || (echo "âŒ ä¾èµ–å®‰è£…å½»åº•å¤±è´¥" && exit 1)
          fi

      - name: æ„å»ºVitePressæ–‡æ¡£
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºæ–‡æ¡£ç«™ç‚¹..."
          if npm run docs:build; then
            echo "âœ… æ–‡æ¡£æ„å»ºæˆåŠŸ"
            echo "ğŸ“‚ æ„å»ºç›®å½•å†…å®¹ï¼š"
            ls -la src/.vitepress/dist
          else
            echo "âŒ æ–‡æ¡£æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: æå–ç‰ˆæœ¬å·å’Œæ—¥æœŸ
        id: info
        run: |
          echo "ğŸ“Œ æå–ç‰ˆæœ¬ä¿¡æ¯..."
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ]; then
            echo "âŒ æ— æ³•ä»package.jsonè·å–ç‰ˆæœ¬å·"
            exit 1
          fi
          DATE=$(date +'%Y-%m-%d')
          ZIP_NAME="WGdocs-${VERSION}-${DATE}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "âœ… ç”Ÿæˆå‹ç¼©åŒ…åç§°ï¼š$ZIP_NAME"

      - name: å‹ç¼©æ„å»ºç»“æœ
        id: zip
        run: |
          echo "ğŸ—œï¸ å¼€å§‹å‹ç¼©æ„å»ºæ–‡ä»¶..."
          cd src/.vitepress/dist
          if zip -r ../../../${{ steps.info.outputs.ZIP_NAME }} .; then
            cd ../../../
            echo "âœ… å‹ç¼©æˆåŠŸ"
            echo "ğŸ“¦ å‹ç¼©åŒ…ä¿¡æ¯ï¼š"
            ls -la ${{ steps.info.outputs.ZIP_NAME }}
            echo "æ–‡ä»¶å¤§å°ï¼š$(du -h ${{ steps.info.outputs.ZIP_NAME }})"
            echo "SIZE=$(du -h ${{ steps.info.outputs.ZIP_NAME }})" >> $GITHUB_OUTPUT
          else
            echo "âŒ å‹ç¼©å¤±è´¥"
            exit 1
          fi

      - name: éªŒè¯WebDAVæœºå¯†é…ç½®
        run: |
          echo "ğŸ” éªŒè¯WebDAVè®¤è¯ä¿¡æ¯..."
          if [ -z "${{ secrets.WEBDAV_USERNAME }}" ] || [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯ï¼šWebDAVç”¨æˆ·åæˆ–å¯†ç æœªé…ç½®"
            exit 1
          else
            echo "âœ… è®¤è¯ä¿¡æ¯å·²é…ç½®"
          fi

      - name: ä¸Šä¼ åˆ°WebDAVæ ¹ç›®å½•
        uses: bxb100/action-upload@main
        with:
          provider: webdav
          provider_options: |
            endpoint=https://pan.huang1111.cn/dav
            username=${{ secrets.WEBDAV_USERNAME }}
            password=${{ secrets.WEBDAV_PASSWORD }}
            root=/
          include: ${{ steps.info.outputs.ZIP_NAME }}
          flatten: true
        continue-on-error: true  # å‡ºé”™åä¸ç«‹å³ç»ˆæ­¢ï¼Œç»§ç»­æ‰§è¡Œåç»­æ£€æŸ¥
        id: upload

      - name: ä¸Šä¼ ç»“æœæ£€æŸ¥
        run: |
          echo "ğŸ“‹ æ£€æŸ¥ä¸Šä¼ ç»“æœ..."
          if [ "${{ steps.upload.outcome }}" = "success" ]; then
            echo "ğŸ‰ ä¸Šä¼ æˆåŠŸï¼"
            echo "ä¸Šä¼ æ–‡ä»¶ï¼š${{ steps.info.outputs.ZIP_NAME }}"
            echo "æ–‡ä»¶å¤§å°ï¼š${{ steps.zip.outputs.SIZE }}"
          else
            echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨curlæ‰‹åŠ¨ä¸Šä¼ ..."
            # å¤‡ç”¨ä¸Šä¼ æ–¹æ¡ˆ
            curl -u ${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }} \
              -T ${{ steps.info.outputs.ZIP_NAME }} \
              "https://pan.huang1111.cn/dav/${{ steps.info.outputs.ZIP_NAME }}" \
              --show-error --fail \
              && echo "âœ… å¤‡ç”¨æ–¹æ¡ˆä¸Šä¼ æˆåŠŸ" \
              || (echo "âŒ æ‰€æœ‰ä¸Šä¼ æ–¹æ¡ˆå‡å¤±è´¥" && exit 1)
          fi
